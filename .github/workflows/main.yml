name: Deploy Frontend build

on:
  push:
    branches: [ main ] 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
        
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Set build time
        id: build_time
        run: |
          # Use the commit's committer date (ISO 8601) as the canonical build time
          # Falls back to current UTC time if git query fails
          TIME=$(git show -s --format=%cI HEAD 2>/dev/null || date -u --iso-8601=seconds)
          echo "time=$TIME" >> $GITHUB_OUTPUT

      - name: Determine NODE_ENV
        id: node_env
        env:
          # Read repository-level variable NODE_ENV if provided
          REPO_NODE_ENV: ${{ vars.NODE_ENV }}
        run: |
          # Prefer repository variable NODE_ENV if set; otherwise default to 'production'
          if [ -n "${REPO_NODE_ENV}" ]; then
            echo "Using repository NODE_ENV=${REPO_NODE_ENV}"
            echo "node_env=${REPO_NODE_ENV}" >> $GITHUB_OUTPUT
          else
            # Default to production for CI builds
            echo "NODE_ENV not set in repository variables â€” defaulting to 'production'"
            echo "node_env=production" >> $GITHUB_OUTPUT
          fi

      - name: Build
        run: npm run build
        env:
          NODE_ENV: ${{ steps.node_env.outputs.node_env }}
          NEXT_PUBLIC_APP_ENV: ${{ steps.node_env.outputs.node_env }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
          NEXT_PUBLIC_GOOGLE_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_API_KEY }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          NEXT_PUBLIC_PLAUSIBLE_DOMAIN: ${{ secrets.NEXT_PUBLIC_PLAUSIBLE_DOMAIN }}
          NEXT_PUBLIC_OTEL_ENABLED: ${{ secrets.NEXT_PUBLIC_OTEL_ENABLED }}
          NEXT_PUBLIC_APP_VERSION: ${{ github.sha }}
          NEXT_PUBLIC_BUILD_TIME: ${{ steps.build_time.outputs.time }}

      - name: Create deployment bundle
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp next.config.ts deploy/
          cp ecosystem.config.js deploy/

      - name: Sync bundle to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "deploy/*"
          target: "/var/www/app-frontend"
          strip_components: 1

      - name: Deploy and Restart via PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /var/www/app-frontend
            echo "Installing production dependencies..."
            npm ci --production --legacy-peer-deps
            
            echo "Reloading application with PM2..."
            # Check if process exists to decide between start or reload
            pm2 describe app-frontend > /dev/null
            if [ $? -eq 0 ]; then
              pm2 reload ecosystem.config.js --update-env
            else
              pm2 start ecosystem.config.js
            fi
            
            echo "Deployment complete!"

      - name: Notify Discord on Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{"content": "**SSR Frontend Deployment Successful!**\n**Project:** Ellipticc Drive\n**Mode:** SSR + PM2\n**Status:** Application is live and PM2 has been reloaded."}' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Notify Discord on Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{"content": "**SSR Frontend Deployment Failed!**\n**Project:** Ellipticc Drive\n**Check Logs:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
