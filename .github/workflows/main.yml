name: Deploy Frontend build

on:
  push:
    branches: [ main ] 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
        
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Set build time
        id: build_time
        run: |
          # Use the commit's committer date (ISO 8601) as the canonical build time
          # Falls back to current UTC time if git query fails
          TIME=$(git show -s --format=%cI HEAD 2>/dev/null || date -u --iso-8601=seconds)
          echo "time=$TIME" >> $GITHUB_OUTPUT

      - name: Determine NODE_ENV
        id: node_env
        env:
          # Read repository-level variable NODE_ENV if provided
          REPO_NODE_ENV: ${{ vars.NODE_ENV }}
        run: |
          # Prefer repository variable NODE_ENV if set; otherwise default to 'production'
          if [ -n "${REPO_NODE_ENV}" ]; then
            echo "Using repository NODE_ENV=${REPO_NODE_ENV}"
            echo "node_env=${REPO_NODE_ENV}" >> $GITHUB_OUTPUT
          else
            # Default to production for CI builds
            echo "NODE_ENV not set in repository variables — defaulting to 'production'"
            echo "node_env=production" >> $GITHUB_OUTPUT
          fi

      - name: Build and Export
        run: npm run build
        env:
          # NODE_ENV for the build — resolved from repository variable or default
          NODE_ENV: ${{ steps.node_env.outputs.node_env }}
          # Expose to frontend as a runtime-accessible public var
          NEXT_PUBLIC_APP_ENV: ${{ steps.node_env.outputs.node_env }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
          NEXT_PUBLIC_GOOGLE_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_API_KEY }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          # Plausible analytics domain (optional; falls back to base URL hostname)
          NEXT_PUBLIC_PLAUSIBLE_DOMAIN: ${{ secrets.NEXT_PUBLIC_PLAUSIBLE_DOMAIN }}
          # Enable frontend OpenTelemetry (set to 'true' to enable)
          NEXT_PUBLIC_OTEL_ENABLED: ${{ secrets.NEXT_PUBLIC_OTEL_ENABLED }}
          # Inject the exact commit SHA used for this build so the frontend can report its version
          NEXT_PUBLIC_APP_VERSION: ${{ github.sha }}
          # Inject build time (ISO 8601); used by About Ellipticc in Settings
          NEXT_PUBLIC_BUILD_TIME: ${{ steps.build_time.outputs.time }}


      - name: Sync static files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "out/*"
          target: "/var/www/drive-static"
          strip_components: 1

      - name: Restart Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "Restarting Nginx..."
            sudo systemctl restart nginx && nginx -s reload
            echo "Nginx restarted!"

      - name: Notify Discord on Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{"content": "**Static Frontend Deployment Successful!**\n**Project:** Ellipticc Drive\n**Branch:** `${{ github.ref_name }}`\n**Status:** Static files are live on VPS! Serving via Nginx."}' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Notify Discord on Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{"content": "**Frontend Deployment Failed!**\n**Project:** Ellipticc Drive\n**Check Logs:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
