.prose:not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    --tw-prose-body: var(--color-text-tertiary);
    --tw-prose-headings: var(--color-text-primary);
    --tw-prose-lead: var(--color-text-tertiary);
    --tw-prose-links: var(--color-text-tertiary);
    --tw-prose-bold: var(--color-text-primary);
    --tw-prose-counters: var(--color-text-tertiary);
    --tw-prose-bullets: var(--color-text-tertiary);
    --tw-prose-hr: var(--color-border-secondary);
    --tw-prose-quotes: var(--color-text-primary);
    --tw-prose-quote-borders: var(--color-fg-brand-primary_alt);
    --tw-prose-captions: var(--color-text-tertiary);
    --tw-prose-code: var(--color-text-tertiary);
    --tw-prose-pre-code: var(--color-text-tertiary);
    --tw-prose-pre-bg: var(--color-bg-primary);
    --tw-prose-th-borders: var(--color-border-primary);
    --tw-prose-td-borders: var(--color-border-secondary);

    /* Base */
    color: var(--tw-prose-body);
    font-size: var(--text-md);
    line-height: var(--text-md--line-height);
}

.prose :not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    /* Text */
    &:where(p) {
        margin-top: calc(var(--spacing) * 4);
        margin-bottom: calc(var(--spacing) * 4);
    }

    &:where([class~="lead"]) {
        font-size: var(--text-md);
        line-height: var(--text-md--line-height);
        margin-top: 1.2em;
        margin-bottom: 1.2em;
    }

    /* Lists */
    &:where(ol) {
        list-style-type: decimal;

        margin-top: calc(var(--spacing) * 4);
        margin-bottom: calc(var(--spacing) * 4);
        padding-inline-start: calc(var(--spacing) * 5.75);
    }
    &:where(ul) {
        list-style-type: disc;

        margin-top: calc(var(--spacing) * 4);
        margin-bottom: calc(var(--spacing) * 4);
        padding-inline-start: calc(var(--spacing) * 5.75);
    }
    &:where(li) {
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 2);
    }
    &:where(ol > li) {
        padding-inline-start: 1px;
        margin-top: 0;
        margin-bottom: 0;
    }
    &:where(ul > li) {
        padding-inline-start: 1px;
        margin-top: 0;
        margin-bottom: 0;
    }

    /* Horizontal rules */
    &:where(hr) {
        margin-top: calc(var(--spacing) * 8);
        margin-bottom: calc(var(--spacing) * 8);
    }

    /* Quotes */
    &:where(blockquote) {
        color: var(--tw-prose-quotes);

        border-left-width: 2px;
        border-left-color: var(--tw-prose-quote-borders);

        padding-inline-start: 0;
        margin-top: calc(var(--spacing) * 10);
        margin-bottom: calc(var(--spacing) * 10);
    }
    &:where(blockquote p) {
        margin: 0;
        font-weight: 500;
        font-style: italic;

        font-size: var(--text-xl);
        line-height: var(--text-xl--line-height);
    }
    &:where(blockquote p:first-of-type::before) {
        content: open-quote;
    }
    &:where(blockquote p:last-of-type::after) {
        content: close-quote;
    }

    /* Headings */
    &:where(h1) {
        color: var(--tw-prose-headings);
        font-weight: 600;

        font-size: var(--text-display-sm);
        line-height: var(--text-display-sm--line-height);
        margin-bottom: calc(var(--spacing) * 5);
        margin-top: calc(var(--spacing) * 10);
    }
    &:where(h2) {
        color: var(--tw-prose-headings);
        font-weight: 600;

        font-size: var(--text-display-xs);
        line-height: var(--text-display-xs--line-height);
        margin-bottom: calc(var(--spacing) * 4);
        margin-top: calc(var(--spacing) * 8);
    }
    &:where(h3) {
        color: var(--tw-prose-headings);
        font-weight: 600;

        font-size: var(--text-xl);
        line-height: var(--text-xl--line-height);
        margin-bottom: calc(var(--spacing) * 3);
        margin-top: calc(var(--spacing) * 8);
    }
    &:where(h4) {
        color: var(--tw-prose-headings);
        font-weight: 600;

        font-size: var(--text-lg);
        line-height: var(--text-lg--line-height);
        margin-bottom: calc(var(--spacing) * 2);
        margin-top: calc(var(--spacing) * 5);
    }

    &:where(h2 + *) {
        margin-top: 0;
    }
    &:where(h3 + *) {
        margin-top: 0;
    }
    &:where(h4 + *) {
        margin-top: 0;
    }

    &:where(h1 strong) {
        font-weight: 900;
        color: inherit;
    }
    &:where(h2 strong) {
        font-weight: 800;
        color: inherit;
    }
    &:where(h3 strong) {
        font-weight: 700;
        color: inherit;
    }
    &:where(h4 strong) {
        font-weight: 700;
        color: inherit;
    }

    /* Media */

    &:where(img) {
        border-radius: var(--radius-xl);
        width: 100%;
        object-fit: cover;

        margin-top: calc(var(--spacing) * 8);
        margin-bottom: calc(var(--spacing) * 8);
    }
    &:where(video) {
        margin-top: calc(var(--spacing) * 8);
        margin-bottom: calc(var(--spacing) * 8);
    }
    &:where(figure) {
        margin-top: calc(var(--spacing) * 10);
        margin-bottom: calc(var(--spacing) * 10);
    }
    &:where(figure > *) {
        margin-top: 0;
        margin-bottom: 0;
    }
    &:where(figure:has(> blockquote)) {
        border-left-width: 2px;
        border-left-color: var(--tw-prose-quote-borders);
        padding-top: calc(var(--spacing) * 2);
        padding-bottom: calc(var(--spacing) * 2);

        padding-inline-start: calc(var(--spacing) * 4);
    }
    &:where(figure:has(> blockquote) blockquote) {
        padding-inline-start: 0;
        border: none;
    }
    &:where(img + figcaption) {
        display: flex;
        align-items: center;
        gap: calc(var(--spacing) * 1.5);
    }
    &:where(figcaption) {
        color: var(--tw-prose-captions);

        font-size: var(--text-sm);
        line-height: var(--text-sm--line-height);
        margin-top: calc(var(--spacing) * 3);
    }
    &:where(cite) {
        font-style: normal;
    }

    /* Inline elements */
    &:where(a:not(h1 a, h2 a, h3 a, h4 a, h5 a, h6 a)) {
        font-weight: 400;
        text-decoration: underline;
        text-underline-offset: 3px;
    }

    &:where(a:focus-visible) {
        border-radius: var(--radius-sm);
        outline: 2px solid var(--color-focus-ring);
        outline-offset: 2px;
    }
    &:where(:is(h1, h2, h3) a) {
        color: var(--tw-prose-headings);
        font-weight: inherit;
        text-decoration: none;
    }

    /* Inline code element */
    &:where(code:not(pre code)) {
        font-size: 0.875rem;
        line-height: 1.25rem;
        font-weight: 700;
        border-radius: 6px;
        padding: calc(var(--spacing) * 0.5) calc(var(--spacing) * 1.5);
        margin: calc(var(--spacing) * -0.5) 0px;
        background: var(--color-bg-secondary);
        box-shadow: 0 0 0 1px var(--color-border-secondary);

        &::before,
        &::after {
            content: "";
        }
    }
}

.prose.prose-centered-quote :not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    &:where(blockquote) {
        padding-inline-start: 0px !important;
        border-left: none;
        text-align: center;
    }
    &:where(figure:has(> blockquote)) {
        border-left: none;
        padding-inline-start: 0px !important;
        padding-top: 0px !important;
        padding-bottom: 0px !important;
        text-align: center;
    }
}

.prose.prose-minimal-quote :not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    &:where(blockquote) {
        border-left: none;
        padding-inline-start: 0px !important;
    }
    &:where(figure:has(> blockquote)) {
        border-left: none;
        padding-inline-start: 0px !important;
    }
}

.prose.md\:prose-lg:not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    @media (width >= 48rem /* 768px */) {
        /* Base */
        font-size: var(--text-lg);
        line-height: var(--text-lg--line-height);
    }
}

.prose.md\:prose-lg :not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    @media (width >= 48rem /* 768px */) {
        /* Text */
        &:where(p) {
            margin-top: calc(var(--spacing) * 4.5);
            margin-bottom: calc(var(--spacing) * 4.5);
        }

        &:where([class~="lead"]) {
            font-size: var(--text-xl);
            line-height: var(--text-xl--line-height);
            margin-top: 1.09em;
            margin-bottom: 1.09em;
        }

        /* Lists */
        &:where(ol) {
            margin-top: calc(var(--spacing) * 4.5);
            margin-bottom: calc(var(--spacing) * 4.5);
            padding-inline-start: calc(var(--spacing) * 6.5);
        }
        &:where(ul) {
            margin-top: calc(var(--spacing) * 4.5);
            margin-bottom: calc(var(--spacing) * 4.5);
            padding-inline-start: calc(var(--spacing) * 6.5);
        }

        &:where(ol > li) {
            padding-inline-start: 1px;
            margin-top: 0;
            margin-bottom: 0;
        }
        &:where(ul > li) {
            padding-inline-start: 1px;
            margin-top: 0;
            margin-bottom: 0;
        }

        /* Horizontal rules */
        &:where(hr) {
            margin-top: calc(var(--spacing) * 8);
            margin-bottom: calc(var(--spacing) * 8);
        }

        /* Quotes */
        &:where(blockquote) {
            padding-inline-start: 0;
            margin-top: calc(var(--spacing) * 12);
            margin-bottom: calc(var(--spacing) * 12);
        }
        &:where(blockquote p) {
            margin: 0;

            font-size: var(--text-display-xs);
            line-height: var(--text-display-xs--line-height);
        }

        /* Headings */
        &:where(h1) {
            font-size: var(--text-display-md);
            line-height: var(--text-display-md--line-height);
            margin-bottom: calc(var(--spacing) * 6);
            margin-top: calc(var(--spacing) * 12);
        }
        &:where(h2) {
            font-size: var(--text-display-sm);
            line-height: var(--text-display-sm--line-height);
            margin-bottom: calc(var(--spacing) * 5);
            margin-top: calc(var(--spacing) * 10);
        }
        &:where(h3) {
            font-size: var(--text-display-xs);
            line-height: var(--text-display-xs--line-height);
            margin-bottom: calc(var(--spacing) * 4);
            margin-top: calc(var(--spacing) * 8);
        }
        &:where(h4) {
            font-size: var(--text-xl);
            line-height: var(--text-xl--line-height);
            margin-bottom: calc(var(--spacing) * 3);
            margin-top: calc(var(--spacing) * 8);
        }
        &:where(h2 + *) {
            margin-top: 0;
        }
        &:where(h3 + *) {
            margin-top: 0;
        }
        &:where(h4 + *) {
            margin-top: 0;
        }

        &:where(figure) {
            margin-top: calc(var(--spacing) * 12);
            margin-bottom: calc(var(--spacing) * 12);
        }
        &:where(figure > *) {
            margin-top: 0;
            margin-bottom: 0;
        }
        &:where(figure:has(> blockquote)) {
            padding-inline-start: calc(var(--spacing) * 5);
        }
        &:where(figure > blockquote + figcaption) {
            font-size: var(--text-md);
            line-height: var(--text-md--line-height);
        }

        &:where(figcaption) {
            margin-top: calc(var(--spacing) * 4);
        }

        /* Inline elements */
        &:where(a:not(h1 a, h2 a, h3 a, h4 a, h5 a, h6 a)) {
            font-weight: 400;
            text-decoration: underline;
            text-underline-offset: 3px;
        }
        &:where(:is(h1, h2, h3) a) {
            color: var(--tw-prose-headings);
            font-weight: inherit;
            text-decoration: none;
        }

        /* Inline code element */
        &:where(code:not(pre code)) {
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: 700;
            border-radius: 6px;
            padding: calc(var(--spacing) * 0.5) calc(var(--spacing) * 1.5);
            margin: calc(var(--spacing) * -0.5) 0px;
            background: var(--color-bg-secondary);
            box-shadow: 0 0 0 1px var(--color-border-secondary);
        }
    }
}

/* Remove top margin from first element */
.prose > :first-child:not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    margin-top: 0;
}
.prose > :last-child:not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    margin-bottom: 0;
}

/* ═══════════════════════════════════════════════════════════════════════════════
   SHIKI CODE BLOCK STYLING
   ═══════════════════════════════════════════════════════════════════════════════
   Custom styling for Shiki-highlighted code blocks. These styles ensure that
   Shiki's VS Code-quality syntax highlighting is preserved and not overridden
   by prose markdown styles.
*/

:root {
    --code-bg: var(--color-bg-secondary);
    --code-text: var(--color-text-primary);
    --code-border: var(--color-border-secondary);
    --code-meta: var(--color-text-tertiary);
    --code-hover: color-mix(in srgb, var(--color-bg-tertiary) 50%, transparent);
}

.dark-mode {
    --code-bg: var(--color-bg-secondary);
    --code-text: var(--color-text-primary);
    --code-border: var(--color-border-secondary);
    --code-meta: var(--color-text-tertiary);
}

/* Shiki pre > code output styling (from shiki library) */
.prose pre {
    background: var(--code-bg) !important;
    border: 1px solid var(--code-border) !important;
    border-radius: var(--radius-sm) !important;
    padding: 0 !important;
    margin: 1.5rem 0 !important;
}

.prose pre code {
    all: inherit;
    background: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    padding: 1rem !important;
    color: var(--code-text) !important;
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
    display: block !important;
    overflow-x: auto !important;
    white-space: pre !important;
    word-wrap: normal !important;
}

/* Preserve Shiki token colors - prevent prose from overriding */
.prose pre code * {
    color: inherit !important;
    background: transparent !important;
}

/* Shiki specific token classes - ensure they render correctly */
.prose code[class*="shiki"],
.prose pre code[class*="shiki"] {
    all: initial;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--code-text);
    background: var(--code-bg);
    display: block;
    padding: 1rem;
    overflow-x: auto;
    white-space: pre;
}

/* Inline code should NOT be highlighted this way - use smaller variant */
.prose :not(pre) > code {
    background: var(--code-bg) !important;
    color: var(--color-fg-brand-primary) !important;
    border: 1px solid var(--code-border) !important;
    border-radius: 3px !important;
    padding: 2px 4px !important;
    font-size: 0.75rem !important;
    font-weight: 600 !important;
}

/* Ensure code block wrapper is properly styled */
.prose > pre {
    position: relative;
}

/* Horizontal scrolling for long lines */
.prose pre code {
    display: block;
    background: var(--code-bg) !important;
}

/* ═══════════════════════════════════════════════════════════════════════════════
   SHIKI CODE BLOCK SYNTAX HIGHLIGHTING PRESERVATION
   ═══════════════════════════════════════════════════════════════════════════════
   Shiki generates HTML with inline styles for syntax tokens. These rules ensure
   that prose markdown styles do not interfere with Shiki's carefully crafted colors.
*/

/* Allow Shiki's inline styles to take precedence */
.prose pre code span {
    all: initial;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
}

/* Light theme - GitHub light theme colors */
[data-theme="light"],
.light-mode {
    color-scheme: light;
}

/* Dark theme - GitHub dark theme colors */
[data-theme="dark"],
.dark-mode {
    color-scheme: dark;
}

/* Responsive code block sizing */
@media (max-width: 640px) {
    .prose pre {
        font-size: 0.8rem !important;
        padding: 0 !important;
    }

    .prose pre code {
        padding: 0.75rem !important;
    }
}

/* Focus states for keyboard navigation */
.prose pre:focus-visible {
    outline: 2px solid var(--color-focus-ring);
    outline-offset: 2px;
}

/* Copy button styling (for ShikiCodeBlock component) */
.prose pre button[data-copy-button] {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.prose pre:hover button[data-copy-button],
.prose pre:focus-within button[data-copy-button] {
    opacity: 1;
}

/* ═══════════════════════════════════════════════════════════════════════════════
   PROSE-SM OVERRIDES FOR CHAT MESSAGES
   ═══════════════════════════════════════════════════════════════════════════════
   Ensures proper heading sizes and spacing for chat context where content should
   feel natural within message bubbles. prose-sm scales down the typography while
   these overrides ensure it's optimized for readability in limited space.
*/

.prose.prose-sm:not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    /* Base sizing for prose-sm */
    font-size: var(--text-sm);
    line-height: var(--text-sm--line-height);
}

.prose.prose-sm :not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    /* Text blocks */
    &:where(p) {
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 2);
    }

    &:where([class~="lead"]) {
        font-size: var(--text-sm);
        line-height: var(--text-sm--line-height);
        margin-top: 1rem;
        margin-bottom: 1rem;
    }

    /* Lists - compact spacing for prose-sm */
    &:where(ol),
    &:where(ul) {
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 2);
        padding-inline-start: calc(var(--spacing) * 4);
    }

    &:where(li) {
        margin-top: calc(var(--spacing) * 1);
        margin-bottom: calc(var(--spacing) * 1);
    }

    /* Headings - appropriately sized for chat bubbles */
    &:where(h1) {
        font-size: var(--text-lg);
        line-height: var(--text-lg--line-height);
        font-weight: 600;
        color: var(--tw-prose-headings);
        margin-top: calc(var(--spacing) * 3);
        margin-bottom: calc(var(--spacing) * 2);
    }

    &:where(h2) {
        font-size: var(--text-base);
        line-height: 1.5;
        font-weight: 600;
        color: var(--tw-prose-headings);
        margin-top: calc(var(--spacing) * 3);
        margin-bottom: calc(var(--spacing) * 2);
    }

    &:where(h3) {
        font-size: var(--text-sm);
        line-height: 1.5;
        font-weight: 600;
        color: var(--tw-prose-headings);
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 1);
    }

    &:where(h4) {
        font-size: var(--text-sm);
        line-height: 1.5;
        font-weight: 600;
        color: var(--tw-prose-headings);
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 1);
    }

    /* Remove margin after headings */
    &:where(h1 + *),
    &:where(h2 + *),
    &:where(h3 + *),
    &:where(h4 + *) {
        margin-top: 0;
    }

    /* Blockquotes */
    &:where(blockquote) {
        border-left-width: 2px;
        border-left-color: var(--tw-prose-quote-borders);
        padding-inline-start: calc(var(--spacing) * 3);
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 2);
        font-style: italic;
    }

    &:where(blockquote p) {
        margin: 0;
        font-size: var(--text-sm);
        line-height: 1.5;
    }

    /* Code blocks - preserve custom styling */
    &:where(pre) {
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border-secondary);
        border-radius: var(--radius-sm);
        padding: calc(var(--spacing) * 2);
        overflow-x: auto;
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 2);
    }

    &:where(pre code) {
        font-size: var(--text-xs);
        color: var(--tw-prose-pre-code);
        background: transparent;
        padding: 0;
        border-radius: 0;
        box-shadow: none;

        &::before,
        &::after {
            content: "";
        }
    }

    /* Inline code */
    &:where(code:not(pre code)) {
        font-size: 0.75rem;
        line-height: 1rem;
        font-weight: 600;
        color: var(--tw-prose-code);
        background: var(--color-bg-secondary);
        border-radius: 3px;
        padding: 2px 4px;
        margin: 0;
        border: 1px solid var(--color-border-secondary);

        &::before,
        &::after {
            content: "";
        }
    }

    /* Links - use theme color */
    &:where(a:not(h1 a, h2 a, h3 a, h4 a, h5 a, h6 a)) {
        color: var(--color-fg-brand-primary);
        text-decoration: underline;
        text-underline-offset: 2px;
        font-weight: 500;

        &:hover {
            opacity: 0.8;
        }

        &:focus-visible {
            outline: 2px solid var(--color-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }
    }

    &:where(:is(h1, h2, h3) a) {
        color: var(--tw-prose-headings);
        text-decoration: none;

        &:hover {
            text-decoration: underline;
        }
    }

    /* Horizontal rules */
    &:where(hr) {
        margin-top: calc(var(--spacing) * 3);
        margin-bottom: calc(var(--spacing) * 3);
        border: none;
        border-top: 1px solid var(--tw-prose-hr);
    }

    /* Images and media */
    &:where(img) {
        border-radius: var(--radius-md);
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 2);
    }

    &:where(video) {
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 2);
    }

    /* Tables */
    &:where(table) {
        margin-top: calc(var(--spacing) * 2);
        margin-bottom: calc(var(--spacing) * 2);
        border-collapse: collapse;
        width: 100%;
        font-size: var(--text-xs);
    }

    &:where(thead) {
        border-bottom: 1px solid var(--tw-prose-th-borders);
    }

    &:where(tbody tr) {
        border-bottom: 1px solid var(--tw-prose-td-borders);
    }

    &:where(th),
    &:where(td) {
        padding: calc(var(--spacing) * 1.5) calc(var(--spacing) * 2);
        text-align: left;
    }
}

/* ═══════════════════════════════════════════════════════════════════════════════
   RESPONSIVE PROSE SCALING FOR CHAT MESSAGES
   ═══════════════════════════════════════════════════════════════════════════════
   On larger screens (md breakpoint: 768px), prose-sm headings scale up slightly
   to maintain hierarchy while still being appropriate for chat bubbles.
*/

@media (min-width: 768px) {
    .prose.prose-sm :not(:where([class~="not-prose"], [class~="not-prose"] *)) {
        /* Slightly larger headings on desktop while maintaining chat proportions */
        &:where(h1) {
            font-size: var(--text-base);
            margin-top: calc(var(--spacing) * 4);
            margin-bottom: calc(var(--spacing) * 2);
        }

        &:where(h2) {
            font-size: var(--text-sm);
            margin-top: calc(var(--spacing) * 3);
            margin-bottom: calc(var(--spacing) * 2);
        }

        /* Slightly better line height on larger screens */
        &:where(p) {
            line-height: 1.6;
        }

        &:where(li) {
            line-height: 1.6;
        }
    }
}

@media (min-width: 1024px) {
    .prose.prose-sm :not(:where([class~="not-prose"], [class~="not-prose"] *)) {
        /* Additional refinements on large screens */
        &:where(p) {
            line-height: 1.65;
        }
    }
}
